<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache">
    <title>二维码生成与预览</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }
        .container {
            text-align: center;
            width: 80%;
            max-width: 600px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }
        .input-group label {
            width: 100%;
            text-align: left;
            margin-bottom: 5px;
            font-size: 18px;
        }
        .input-group input[type="text"],.input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .input-group select option {
            line-height: 34px;
            padding: 10px;
            font-size: 18px;
        }
        .input-group div {
            flex: 1;
        }
        .input-group div img {
            height: 120px;
            width: 80px;
            float: left;
            margin-right: 10px; 
            margin-bottom: 10px; 
        }
        button {
            width: 100%;
            margin: 15px 0;
            padding: 12px;
            font-size: 18px;
            box-sizing: border-box;
        }
        #qrCode img {
            margin-top: 20px;
            max-width: 100%;
        }
        @media (min-width: 600px) {
            .input-group {
                flex-direction: row;
            }
            .input-group label {
                width: 30%;
                text-align: right;
                margin-right: 10px;
                margin-bottom: 0;
            }
            .input-group input[type="text"],.input-group input[type="color"],.input-group textarea, .input-group select {
                flex: 1;
            }
            .input-group #images {
                flex: 1;
            }
            .input-group #images img {
                height: 120px;
                width: 80px;
                float: left;
                margin-right: 10px; 
            }
            .input-group #images iframe {
                height: 120px;
                width: 80px;
                float: left;
                margin-right: 10px; 
            }
            button {
                width: auto;
            }
        }
    </style>
    <link rel="stylesheet" href="./static/message.min.css">  
</head>
<body>
    <div class="container">
        <h1>二维码生成与预览</h1>
        <div class="input-group">
            <label for="text1">电池编号（可填多个）:</label>
            <textarea id="battery_num" rows="3" placeholder="电池编号">MA53HLYM5191100014560B41011896</textarea>
        </div>
        <div class="input-group">
            <label for="text1">蓄电池类型:</label>
            <select id="battery_type" name="battery_type">
                <option value="1" selected>锂电</option>
                <option value="2">铅酸</option>
            </select>
        </div>
        <div class="input-group">
            <label for="text2">蓄电池生产企业:</label>
            <select id="battery_company" name="battery_company">
                <option value="1" selected>东莞新能安科技有限公司</option>
                <option value="2">星恒电源(滁州)有限公司-48V 24A</option>
                <option value="3">星恒电源(滁州)有限公司-48V 12A</option>
                <option value="16">星恒电源(滁州)有限公司-48V 14A</option>
                <option value="4">山东爱德邦智能科技有限公司</option>
                <option value="5">厦门新能安科技有限公司</option>
                <option value="6">台州爱德邦智能科技有限公司</option>
                <option value="7">浙江超威创元实业有限公司-DZ48NZ-24EM</option>
                <option value="8">浙江超恒动力科技有限公司</option>
                <option value="9">湖州天丰电源有限公司</option>
                <option value="10">浙江超威创元实业有限公司-48V 16A</option>
                <option value="11">山东爱德邦智能科技有限公司-DZ48NZ-24AM</option>
                <option value="12">旭派电源有限公司</option>
                <option value="13">天能帅福得能源股份有限公司-48V-24Ah</option>
                <option value="14">肇庆国信通新能源科技有限公司</option>
                <option value="15">天能电池集团股份有限公司-6-DZF-12</option>
                <option value="21">天能电池集团股份有限公司-6-DZF-16</option>
                <option value="17">浙江超威创元实业有限公司-48V-20A</option>
                <option value="18">浙江超威动力能源有限公司-6-DZF-12</option>
                <option value="19">超威电源集团有限公司长兴郎山分公司</option>
                <option value="20">天能帅福得能源股份有限公司-48V-20Ah</option>
                <option value="22">超威电源集团有限公司-6-DZF-16</option>
                <option value="23">超威电源集团有限公司-6­-DZF-12</option>
            </select>
        </div>
        <div class="input-group">
            <label for="text3">蓄电池容量（Ah）:</label>
            <input type="text" id="battery_size" placeholder="蓄电池容量" value="24">
        </div>
        <div class="input-group">
            <label for="text3">蓄电池型号:</label>
            <input type="text" id="battery_model" placeholder="蓄电池型号" value="DZ48N-24EM">
        </div>
        <div class="input-group">
            <label for="text3">蓄电池重量:</label>
            <select id="battery_kg" name="battery_kg">
                <option value="1" >6.5±0.5(kg)</option>
                <option value="2" >7.5±0.5(kg)</option>
                <option value="3" selected>8.5±0.5(kg)</option>
                <option value="4" >3.85kg</option>
                <option value="5" >4.5±0.5(kg)</option>
            </select>
        </div>
        <div class="input-group">
            <label for="text3">生产日期:</label>
            <input type="text" id="battery_date" placeholder="生产日期" value="2023-06-01">
        </div>
        <div class="input-group">
            <label for="imageUpload">报告文件:</label>
            <div id="images" class="images" >
                <!-- <img src="./report/东莞新能安科技有限公司/产品认证证书.jpg" width="80" height="120" style="float: left;"/> -->
            </div>
        </div>
        <div class="input-group">
            <label for="text3">二维码颜色:</label>
            <input type="color" id="dark_color" value="#000000">
        </div>
        <div class="input-group">
            <label for="text3">二维码背景颜色:</label>
            <input type="color" id="light_color" value="#ffffff">
            &nbsp;&nbsp;&nbsp;透明：
            <input type="checkbox" id="light_opacity" enableAlpha>
        </div>
        <div class="input-group">
            <label for="text3">文字颜色:</label>
            <input type="color" id="font_color" value="#2628ff">
        </div>
        <button id="preview">预览</button>
        <button id="generateQR">生成二维码</button>
        <button id="downloadPng">png打包下载</button>
        <button id="downloadSvg">svg打包下载</button>
        <button id="cpoyLink">复制链接</button>
        <div id="result"></div>
    </div>

    <script src="./static/qrcode.min.js"></script>
    <script src="./static/jszip.min.js"></script>
    <script src="./static/info.js"></script>
    <script src="./static/clipboard.min.js"></script>
    <script src="./static/message.min.js"></script>
    <script>
        function loadReportPath(battery_company){
            var fileName = "./report/" + battery_company + ".jpg"
            return fileName
        }
        function loadImgs() {
            var reportPath = loadReportPath(companyMap.get(document.getElementById('battery_company').value.trim())); 
            var fileContainer = document.getElementById('images');
            fileContainer.innerHTML = ''; 
            var a = document.createElement('a');
            a.href = reportPath;
            a.innerHTML = reportPath
            a.target="_blank"
            fileContainer.appendChild(a);
        }
        loadImgs()
        document.getElementById('battery_company').addEventListener('change', loadImgs);

        loadClipboardListener()
        function loadClipboardListener(){
            var clipboard = new ClipboardJS('#cpoyLink', {
                text: function () {
                    const battery_nums = document.getElementById('battery_num').value;
                    const disArray = Array.from(new Set(battery_nums.split("\n")))
                    return disArray.map(bn => getUrl(bn)).join("\n")
                },
            });
            clipboard.on('success', function (e) {
                Qmsg.info("复制成功",{});
            });

            clipboard.on('error', function (e) {
                Qmsg.info("复制失败",{});
            });
        }

        function getUrl(battery_num){
            const battery_type = document.getElementById('battery_type').value;
            const battery_company = document.getElementById('battery_company').value;
            const battery_size = document.getElementById('battery_size').value;
            const battery_model = document.getElementById('battery_model').value;
            const battery_kg = document.getElementById('battery_kg').value;
            const battery_date = document.getElementById('battery_date').value.substring(2);
            const url = `?n=${encodeURIComponent(battery_num)}`
            +`&t=${encodeURIComponent(battery_type)}`
            +`&c=${encodeURIComponent(battery_company)}`
            +`&s=${encodeURIComponent(battery_size)}`
            +`&m=${encodeURIComponent(battery_model)}`
            +`&k=${encodeURIComponent(battery_kg)}`
            +`&d=${encodeURIComponent(battery_date)}`;
            return window.location.href.substring(0, window.location.href.lastIndexOf("/") + 1) + url;
        }
        
        document.getElementById('preview').addEventListener('click', function() {
            const battery_nums = document.getElementById('battery_num').value;
            const url = getUrl(battery_nums.split("\n")[0]);
            window.open(url, '_blank');
        });
        document.getElementById('generateQR').addEventListener('click', function() {
            const battery_nums = document.getElementById('battery_num').value;
            const dark_color = document.getElementById('dark_color').value;
            const light_color = document.getElementById('light_color').value;
            const light_opacity = document.getElementById('light_opacity').checked;
            const font_color = document.getElementById('font_color').value;
            document.getElementById('result').innerHTML = '';
            const disArray = Array.from(new Set(battery_nums.split("\n")))
            disArray.forEach(battery_num => {
                const urlText = getUrl(battery_num);
                genQrCode(urlText, battery_num, light_color, dark_color, font_color, light_opacity)
            })
        });
        document.getElementById('downloadPng').addEventListener('click', function () {
            const svgDivs = document.querySelectorAll('.svg-code');
            var zip = new JSZip();
            svgDivs.forEach((svgDiv,index) => {
                const imgName = svgDiv.name + ".png";
                svg2Png(svgDiv.innerHTML, function(base64) {
                    zip.file(imgName, base64)
                    if(index === svgDivs.length - 1){
                        downloadZip(zip, 'png')
                    }
                })
            });
        });
        document.getElementById('downloadSvg').addEventListener('click', function () {
            const svgDivs = document.querySelectorAll('.svg-code');
            var zip = new JSZip();
            svgDivs.forEach(svgDiv => {
                const imgName = svgDiv.name + ".svg";
                zip.file(imgName, svgDiv.innerHTML);
            });
            downloadZip(zip, 'svg')
        });
    </script>
    <script>
        function genQrCode(urlText, battery_num, light, dark, fontColor, light_opacity) {
            QRCode.toString(urlText, {
                type: "svg",
                scale: 4,
                width: 340,
                color: {
                    light: light,
                    dark: dark
                }
            }, function (err, svg) {
                const resultContainer = document.getElementById('result');
                const div = document.createElement('div');
                div.id = 'id' + battery_num
                div.name = battery_num
                div.className = 'svg-code'
                div.innerHTML = svg
                resultContainer.appendChild(div);
                addTextSvg(battery_num, light, dark, fontColor, light_opacity)
            });
        }
        function addTextSvg(battery_num, light, dark, fontColor, light_opacity){
            const svg = document.querySelector(`#id${battery_num} svg`);
            const path = document.querySelectorAll(`#id${battery_num} svg path`)[0]
            const height = Number(svg.getAttribute('height'));
            const scale = Number(svg.getAttribute('viewBox').split(" ")[3]);
            var rate = Number(height / scale);
            const padding = 16 / rate
            const fontSize = 34 / rate

            const fontTop = 36 / rate;
            const words = lengthCutting(battery_num, 15)
            const bigFontSize = fontSize + 2
            const yTop = 40 / rate;
            const firstY = scale+yTop + bigFontSize / 2
            const addScale = yTop + bigFontSize / 2 + 37 / rate + words.length * (fontSize) - padding + 4;
            const h = (scale+addScale+padding*2+padding)/(scale+padding*2+padding)*height + rate
            svg.setAttribute('height', `${h}`);
            svg.setAttribute('viewBox', `${-padding} ${-padding} ${scale+padding*2} ${scale+addScale+padding*2}`); 
            if(light_opacity){
                path.setAttribute('fill-opacity', "0")
            }
            path.setAttribute('d', `M${-padding} ${-padding}h${scale+padding*2}v${scale+addScale+padding*2}H${-padding}z`)
            const x = scale / 2
            var innerHTML = `<text fill="${fontColor}" stroke="none" font-family="Arial" font-size="${bigFontSize}px" font-style="normal" font-weight="1000" text-decoration="normal" x="${x}" y="${firstY}" text-anchor="middle" dominant-baseline="alphabetic">浙品码</text>`
            words.forEach((word, index) => {
                const y = firstY + bigFontSize / 2 + 37 / rate +((index)*(fontSize / 2 + (20 / rate)))
                innerHTML += `<text fill="${fontColor}" stroke="none" font-family="Arial" font-size="${fontSize}px" font-style="normal" font-weight="bold" text-decoration="normal" x="${x}" y="${y}" text-anchor="middle" dominant-baseline="alphabetic">${word}</text>`
            })
            svg.innerHTML += innerHTML
        }
        function lengthCutting(str, num) {
            let reg = new RegExp(`(.{${num}})`),
            arr = str.split(reg);
            arr = arr.filter(item => item != "");
            return arr;
        }
        function addTextCanvas(battery_num, light, dark){
            const qrSize = 340;
            const maxWidth = qrSize

            function getLines(text, maxWidth) {
                var cttx = document.createElement('canvas').getContext('2d');
                cttx.font = 'bold 20px Arial';
                const words = text.split('');
                const lines = [];
                let currentLine = words[0];

                for (let i = 1; i < words.length; i++) {
                    const word = words[i];
                    const width = cttx.measureText(currentLine + word).width;
                    if (width < maxWidth) {
                        currentLine += word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                }
                lines.push(currentLine);
                return lines;
            }


            const lineHeight = 20;
            const padding = 8;
            const lines = getLines(battery_num, maxWidth - padding);
            const textHeight = (lines.length + 1) * lineHeight*1.2;

            var ctx = new C2S(qrSize,qrSize + textHeight + padding);
            ctx.fillStyle = light;
            ctx.fillRect(0, 0, qrSize, qrSize + textHeight + padding);
            // ctx.drawImage(img, 0, 0);

            ctx.fillStyle = dark;
            ctx.textAlign = 'center';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('浙品码', qrSize / 2, qrSize + lineHeight);
            ctx.font = 'bold 20px Arial';
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], qrSize / 2, qrSize + (i + 2) * lineHeight*1.2);
            }
            return ctx;
        }
        function getDateStr(now){
            var year = now.getFullYear();
            var month = now.getMonth() + 1; // 月份从0开始，因此需要加1
            var day = now.getDate();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();
            return year+''+month+''+ day+''+ hours+''+ minutes+''+ seconds;
        }
        function downloadZip(zip, suffix) {
            // 生成zip文件并下载
            zip.generateAsync({ 
                type: 'blob'
                }).then(function(content) {
                // 下载的文件名
                var filename = 'download_' + suffix + "_" + getDateStr(new Date()) + '.zip';
                // 创建隐藏的可下载链接
                var eleLink = document.createElement('a');
                eleLink.download = filename;
                eleLink.style.display = 'none';
                // 下载内容转变成blob地址
                eleLink.href = URL.createObjectURL(content);
                // 触发点击
                document.body.appendChild(eleLink);
                eleLink.click();
                // 然后移除
                document.body.removeChild(eleLink);
                });
        }
        function svg2Png(svg, callback){
            var img = document.createElement('img');
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            img.onload = function(){
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img,0,0);
                const imgBase64=dataURLToBlob(canvas.toDataURL('image/png'))
                callback(imgBase64)
            }
            img.src = 'data:image/svg+xml;base64,'+window.btoa(unescape(encodeURIComponent(svg)))
        }
        function dataURLToBlob(dataurl) {
            let arr = dataurl.split(','),
                mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]),
                n = bstr.length,
                u8arr = new Uint8Array(n)
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n)
            }
            return new Blob([u8arr], { type: mime })
        }
    </script>
</body>
</html>
